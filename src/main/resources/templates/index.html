<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Domovská stránka | CarPoolMate</title>
    <div th:replace="fragments/head"></div>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-5">
    <h1 class="mb-4">Najít jízdu</h1>

    <!-- Tlačítko pro rozbalení filtrace -->
    <button class="btn btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#filterForm"
            aria-expanded="false" aria-controls="filterForm">
        <i class="fas fa-filter"></i> Filtrace
    </button>


    <!-- Schovaný form pro filtraci -->
    <div class="collapse" id="filterForm">
        <form class="row g-3 mb-4" th:action="@{/rides/filter}" method="get">
            <div class="col-md-3 position-relative">
                <input type="text" id="startLocation" name="startLocation" class="form-control" placeholder="Odkud" autocomplete="off">
                <ul id="startLocationSuggestions" class="list-group mt-2" style="display:none;"></ul>
            </div>

            <div class="col-md-3 position-relative">
                <input type="text" id="destination" name="destination" class="form-control" placeholder="Kam" autocomplete="off">
                <ul id="destinationSuggestions" class="list-group mt-2" style="display:none;"></ul>
            </div>

            <script>
                // Function to fetch suggestions based on user input
                function fetchSuggestions(inputId, suggestionsListId, field) {
                    let inputValue = document.getElementById(inputId).value;
                    if (inputValue.length >= 2) {  // Start fetching suggestions after 2 characters
                        fetch(`/api/locations/suggestions?query=${inputValue}&field=${field}`)
                            .then(response => response.json())
                            .then(data => {
                                let suggestionsList = document.getElementById(suggestionsListId);
                                suggestionsList.innerHTML = '';  // Clear previous suggestions
                                data.forEach(location => {
                                    let listItem = document.createElement('li');
                                    listItem.classList.add('list-group-item');
                                    listItem.textContent = location;
                                    listItem.addEventListener('click', function () {
                                        document.getElementById(inputId).value = location;
                                        suggestionsList.style.display = 'none'; // Hide suggestions after selection
                                    });
                                    suggestionsList.appendChild(listItem);
                                });
                                suggestionsList.style.display = data.length > 0 ? 'block' : 'none'; // Show or hide based on results
                            });
                    } else {
                        document.getElementById(suggestionsListId).style.display = 'none';
                    }
                }

                // Event listeners for the input fields
                document.getElementById('startLocation').addEventListener('input', function () {
                    fetchSuggestions('startLocation', 'startLocationSuggestions', 'startLocation');
                });

                document.getElementById('destination').addEventListener('input', function () {
                    fetchSuggestions('destination', 'destinationSuggestions', 'destination');
                });
            </script>
            <div class="col-md-2">
                <input type="date" name="departureDate" class="form-control">
            </div>
            <div class="col-md-2">
                <input type="time" name="departureTime" class="form-control" placeholder="Čas od">
            </div>
            <div class="col-md-2">
                <input type="number" name="maxPrice" class="form-control" placeholder="Max. cena">
            </div>
            <div class="col-md-2">
                <input type="number" name="minSeats" class="form-control" placeholder="Min. místa">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i> Vyhledat</button>
            </div>
        </form>
    </div>


    <!-- RIDE CARDS -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" th:if="${rides != null}">
        <div class="col" th:each="ride : ${rides}">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title" th:text="${ride.startLocation} + ' → ' + ${ride.destination}"></h5>
                    <p class="card-text">
                        <strong>Datum:</strong> <span th:text="${ride.formattedDepartureTime}"></span><br>
                        <strong>Cena za sedadlo:</strong> <span th:text="${ride.pricePerSeat} + ' Kč'"></span><br>
                        <strong>Volná místa:</strong> <span th:text="${ride.availableSeats}"></span><br>
                        <strong>Řidič:</strong>
                        <a th:href="@{/profiles/{id}(id=${ride.driver.id})}"
                           th:text="${ride.driver.getFirstName() + ' ' + ride.driver.getLastName()}"></a>

                    </p>
                    <a th:href="@{'/rides/' + ${ride.id}}" class="btn btn-outline-primary">Zobrazit</a>
                </div>
            </div>
        </div>
    </div>

    <!-- No rides found -->
    <div th:if="${rides != null and #lists.isEmpty(rides)}" class="alert alert-warning mt-4">
        Žádné jízdy nebyly nalezeny pro zadané parametry.
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>
</body>
</html>